using LsqFit
using CairoMakie

update_theme!(theme_latexfonts());
update_theme!(Theme(fontsize=11));

Ecut = 36:0.5:44;

Etot_vs_Ecut = [-6.2285790154E+01, -6.2285849502E+01, -6.2285904270E+01, -6.2285945829E+01, -6.2285976267E+01, -6.2286001080E+01, -6.2286019005E+01, -6.2286032600E+01, -6.2286042732E+01, -6.2286050036E+01, -6.2286054333E+01, -6.2286057372E+01, -6.2286059439E+01, -6.2286060592E+01, -6.2286061217E+01, -6.2286061528E+01, -6.2286061662E+01];

m(x,p) = p[1] .+ exp.(p[2]*x .+ p[3]);
fit = curve_fit(m, Ecut, Etot_vs_Ecut, [-62.282, -0.5, 12]);

begin
    fig = Figure(size=(300, 250), figure_padding=2)
    ax = Axis(fig[1,1], xlabel="Cutoff Energy (Ha)", ylabel="Total Energy (mHa) (62.3 Ha offset)");
    xs = LinRange(36, 43.5, 101);
    fit_curve = lines!(ax, xs, map(x -> (m(x,fit.param) + 62.3) *1e3, xs), linestyle=:dash, color=:black);
    points = scatter!(ax, Ecut, (Etot_vs_Ecut .+ 62.3) .* 1e3, markersize=10, color=:coral);
    axislegend(ax, [points, fit_curve], ["Points", "Exponential fit"], position=:rt);
    display(fig);
end

save("dft/fig/conv-Ecut.svg", fig, pt_per_unit=1)

# is 42Ha a good cutoff? Compute error:
exp(42*fit.param[2] + fit.param[3])*1e6 # -> 9.5uHa


# -------------------------------------------------------------------------------------------------------------------

# polynomial function used for fitting
polynomial(x, coeffs) = sum(enumerate(coeffs)) do (i, c)
    return c * x ^ (i-1);
end


begin
    E_vs_kt = [-6.2291829074E+01,-6.2291850596E+01,-6.2291877689E+01,-6.2291911798E+01,-6.2291954738E+01,-6.2292008795E+01,-6.2292076713E+01,-6.2292159775E+01,-6.2292250136E+01,-6.2292328058E+01,-6.2292383554E+01,-6.2292437131E+01,-6.2292524101E+01,-6.2292656240E+01,-6.2292778517E+01,-6.2292762576E+01,-6.2292470060E+01,-6.2291783451E+01,-6.2290594936E+01,-6.2289232654E+01,-6.2288870809E+01,-6.2283046078E+01,-6.2283056985E+01,-6.2283070518E+01,-6.2283087568E+01,-6.2283112500E+01,-6.2283151216E+01,-6.2283209610E+01,-6.2283292445E+01,-6.2283395247E+01,-6.2283502441E+01,-6.2283600796E+01,-6.2283696989E+01,-6.2283829439E+01,-6.2284009817E+01,-6.2284210203E+01,-6.2284384673E+01,-6.2284463211E+01,-6.2284401687E+01,-6.2284242726E+01,-6.2284210868E+01,-6.2285167897E+01,-6.2285970799E+01,-6.2285975123E+01,-6.2285980912E+01,-6.2285987486E+01,-6.2285991638E+01,-6.2285993014E+01,-6.2286000903E+01,-6.2286026380E+01,-6.2286072916E+01,-6.2286108016E+01,-6.2286059439E+01,-6.2285955075E+01,-6.2285912916E+01,-6.2286005297E+01,-6.2286160175E+01,-6.2286173532E+01,-6.2285960305E+01,-6.2285605574E+01,-6.2285186751E+01,-6.2284936928E+01,-6.2285710758E+01,-6.2286253238E+01,-6.2286250571E+01,-6.2286245093E+01,-6.2286234554E+01,-6.2286218764E+01,-6.2286198130E+01,-6.2286174478E+01,-6.2286155003E+01,-6.2286142969E+01,-6.2286134131E+01,-6.2286134962E+01,-6.2286171497E+01,-6.2286259339E+01,-6.2286372705E+01,-6.2286448271E+01,-6.2286402809E+01,-6.2286182547E+01,-6.2285805863E+01,-6.2285325237E+01,-6.2284989119E+01,-6.2285698345E+01,-6.2286371120E+01,-6.2286374091E+01,-6.2286378446E+01,-6.2286385923E+01,-6.2286399024E+01,-6.2286420631E+01,-6.2286452524E+01,-6.2286487264E+01,-6.2286497327E+01,-6.2286464672E+01,-6.2286419131E+01,-6.2286396483E+01,-6.2286412827E+01,-6.2286456661E+01,-6.2286476565E+01,-6.2286375409E+01,-6.2286102947E+01,-6.2285711001E+01,-6.2285252370E+01,-6.2284951836E+01,-6.2285688016E+01,-6.2286030921E+01,-6.2286033008E+01,-6.2286035219E+01,-6.2286036612E+01,-6.2286037807E+01,-6.2286041927E+01,-6.2286052261E+01,-6.2286069421E+01,-6.2286092478E+01,-6.2286121636E+01,-6.2286161826E+01,-6.2286219896E+01,-6.2286289680E+01,-6.2286350184E+01,-6.2286367556E+01,-6.2286284329E+01,-6.2286060199E+01,-6.2285707033E+01,-6.2285260736E+01,-6.2284958504E+01,-6.2285690439E+01,-6.2286345824E+01,-6.2286347725E+01,-6.2286350842E+01,-6.2286356127E+01,-6.2286363151E+01,-6.2286367892E+01,-6.2286365627E+01,-6.2286357512E+01,-6.2286350220E+01,-6.2286346959E+01,-6.2286342387E+01,-6.2286333154E+01,-6.2286331987E+01,-6.2286356905E+01,-6.2286380921E+01,-6.2286309876E+01,-6.2286080707E+01,-6.2285716412E+01,-6.2285262851E+01,-6.2284958147E+01,-6.2285690120E+01,-6.2286425790E+01,-6.2286424576E+01,-6.2286424078E+01,-6.2286424640E+01,-6.2286426189E+01,-6.2286427499E+01,-6.2286425891E+01,-6.2286419676E+01,-6.2286410300E+01,-6.2286401469E+01,-6.2286397313E+01,-6.2286398938E+01,-6.2286405265E+01,-6.2286416033E+01,-6.2286410085E+01,-6.2286317090E+01,-6.2286079977E+01,-6.2285714424E+01,-6.2285261946E+01,-6.2284958063E+01,-6.2285690169E+01,-6.2286575049E+01,-6.2286574762E+01,-6.2286575142E+01,-6.2286576560E+01,-6.2286578753E+01,-6.2286580164E+01,-6.2286575869E+01,-6.2286559242E+01,-6.2286528930E+01,-6.2286486953E+01,-6.2286438493E+01,-6.2286397154E+01,-6.2286379652E+01,-6.2286389904E+01,-6.2286393993E+01,-6.2286309531E+01,-6.2286077481E+01,-6.2285714202E+01,-6.2285262091E+01,-6.2284958099E+01,-6.2285690169E+01,-6.2286534781E+01,-6.2286533882E+01,-6.2286533131E+01,-6.2286532474E+01,-6.2286531099E+01,-6.2286527060E+01,-6.2286518534E+01,-6.2286504137E+01,-6.2286482191E+01,-6.2286452220E+01,-6.2286415981E+01,-6.2286382237E+01,-6.2286367566E+01,-6.2286380715E+01,-6.2286389931E+01,-6.2286309596E+01,-6.2286078242E+01,-6.2285714430E+01,-6.2285262100E+01,-6.2284958101E+01,-6.2285690178E+01];
    E_vs_kt = (E_vs_kt .+ 62.3) * 1e3;
    E_vs_kt = reshape(E_vs_kt, (21, 10));
end

begin
    fig = Figure(size=(450, 300), figure_padding=2)
    ax = Axis(
        fig[1,1], 
        xscale=log10,
        xticks=vcat(1:1:10, 20:10:80),
        xlabel="Smearing (mHa)", 
        ylabel="Total Energy (mHa) (62.3 mHa offset)"
    );
    xlims!(ax, nothing, 90);
    # ylims!(ax, 18.8, 20.6)
    x = logrange(1, 100, 21);
    xx = [ones(21) x x.^2 x.^3 x.^4 x.^5 x.^6 x.^7];
    xs = logrange(1, 100, 101);
        
    sel = 5:12;
    cm = cgrad(:managua, length(sel), rev=true, categorical=true)
    for (i,k) in enumerate(sel)
        y = E_vs_kt[:, k-2]
        # A = xx \ y;
        # ys = map(v -> polynomial(v, A), xs);
        # lines!(ax, xs, ys, color=clr, linestyle=:dash)
        scatter!(ax, x, y, label="$k", color=cm[i], markersize=8)
    end

    axislegend(ax, "Number of grid points", position=:lt, orientation=:horizontal, nbanks=2, patchsize=(10,10))
    display(fig)
end

save("dft/fig/conv-kpt-smear.svg", fig, pt_per_unit=1)

# begin
#     ts = logrange(1e-3, 0.1, 21);
#     ks = 3:12;
#     params = [(k,t) for k ∈ ks for t ∈ ts];
#     text = join(map(enumerate(params)) do (i,p)
#         return "ngkpt$i $(p[1]) $(p[1]) $(p[1])\ntsmear$i $(p[2])"
#     end, "\n\n");
#     write("./gay.txt", text)
# end