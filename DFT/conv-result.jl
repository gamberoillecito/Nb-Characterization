using LsqFit
using CairoMakie

update_theme!(theme_latexfonts());
update_theme!(Theme(fontsize=11));

Ecut = 36:0.5:43.5;

Etot_vs_Ecut = [-6.2279903071E+01, -6.2279961611E+01, -6.2280015571E+01, -6.2280056486E+01, -6.2280086398E+01, -6.2280110753E+01, -6.2280128324E+01, -6.2280141561E+01, -6.2280151461E+01, -6.2280158544E+01, -6.2280162703E+01, -6.2280165619E+01, -6.2280167595E+01, -6.2280168690E+01, -6.2280169274E+01, -6.2280169567E+01]; 

m(x,p) = p[1] .+ exp.(p[2]*x .+ p[3]);
fit = curve_fit(m, Ecut, Etot_vs_Ecut, [-62.282, -0.5, 12]);

begin
    fig = Figure(size=(300, 250), figure_padding=2)
    ax = Axis(fig[1,1], xlabel="Cutoff Energy (Ha)", ylabel="Total Energy (mHa) (62.3 Ha offset)");
    xs = LinRange(36, 43.5, 101);
    fit_curve = lines!(ax, xs, map(x -> (m(x,fit.param) + 62.3) *1e3, xs), linestyle=:dash, color=:black);
    points = scatter!(ax, Ecut, (Etot_vs_Ecut .+ 62.3) .* 1e3, markersize=10, color=:coral);
    axislegend(ax, [points, fit_curve], ["Points", "Exponential fit"], position=:rt);
    display(fig);
end

save("dft/fig/conv-Ecut.svg", fig, pt_per_unit=1)

# is 42Ha a good cutoff? Compute error:
exp(42*fit.param[2] + fit.param[3])*1e6 # -> 22uHa


# -------------------------------------------------------------------------------------------------------------------

# polynomial function used for fitting
polynomial(x, coeffs) = sum(enumerate(coeffs)) do (i, c)
    return c * x ^ (i-1);
end


begin
    E_vs_kt = [-6.2286390497E+01, -6.2286412018E+01, -6.2286439112E+01, -6.2286473220E+01, -6.2286516160E+01, -6.2286570217E+01, -6.2286638132E+01, -6.2286721148E+01, -6.2286811297E+01, -6.2286888809E+01, -6.2286943968E+01, -6.2286997606E+01, -6.2287085438E+01, -6.2287219388E+01, -6.2287343123E+01, -6.2287326873E+01, -6.2287032522E+01, -6.2286344308E+01, -6.2285155973E+01, -6.2283795143E+01, -6.2283435472E+01, -6.2277605833E+01, -6.2277616710E+01, -6.2277630304E+01, -6.2277647231E+01, -6.2277671585E+01, -6.2277709415E+01, -6.2277766834E+01, -6.2277848778E+01, -6.2277950687E+01, -6.2278056657E+01, -6.2278153794E+01, -6.2278249672E+01, -6.2278383356E+01, -6.2278565681E+01, -6.2278767317E+01, -6.2278942089E+01, -6.2279019786E+01, -6.2278957073E+01, -6.2278798435E+01, -6.2278769211E+01, -6.2279730023E+01, -6.2280525704E+01, -6.2280529919E+01, -6.2280535676E+01, -6.2280542566E+01, -6.2280546375E+01, -6.2280545473E+01, -6.2280552091E+01, -6.2280577744E+01, -6.2280625333E+01, -6.2280662005E+01, -6.2280615501E+01, -6.2280512733E+01, -6.2280471418E+01, -6.2280564590E+01, -6.2280720344E+01, -6.2280733719E+01, -6.2280519402E+01, -6.2280163470E+01, -6.2279744637E+01, -6.2279496783E+01, -6.2280273875E+01, -6.2280816511E+01, -6.2280813792E+01, -6.2280808103E+01, -6.2280797100E+01, -6.2280780843E+01, -6.2280760002E+01, -6.2280736521E+01, -6.2280717126E+01, -6.2280704930E+01, -6.2280696076E+01, -6.2280697073E+01, -6.2280733908E+01, -6.2280822310E+01, -6.2280935963E+01, -6.2281010850E+01, -6.2280963742E+01, -6.2280741502E+01, -6.2280363397E+01, -6.2279882915E+01, -6.2279548863E+01, -6.2280261338E+01, -6.2280932851E+01, -6.2280935242E+01, -6.2280939198E+01, -6.2280946615E+01, -6.2280959970E+01, -6.2280982052E+01, -6.2281014643E+01, -6.2281050463E+01, -6.2281062132E+01, -6.2281030715E+01, -6.2280985391E+01, -6.2280962450E+01, -6.2280978200E+01, -6.2281020963E+01, -6.2281039339E+01, -6.2280936379E+01, -6.2280662004E+01, -6.2280268547E+01, -6.2279809953E+01, -6.2279511514E+01, -6.2280251000E+01, -6.2280601905E+01, -6.2280603226E+01, -6.2280604866E+01, -6.2280605778E+01, -6.2280606413E+01, -6.2280609873E+01, -6.2280619498E+01, -6.2280636023E+01, -6.2280658613E+01, -6.2280687390E+01, -6.2280727125E+01, -6.2280784655E+01, -6.2280853982E+01, -6.2280913952E+01, -6.2280930203E+01, -6.2280845210E+01, -6.2280619150E+01, -6.2280264556E+01, -6.2279818345E+01, -6.2279518202E+01, -6.2280253429E+01, -6.2280914778E+01, -6.2280915948E+01, -6.2280918330E+01, -6.2280923017E+01, -6.2280929720E+01, -6.2280934419E+01, -6.2280932104E+01, -6.2280923686E+01, -6.2280915939E+01, -6.2280912398E+01, -6.2280907896E+01, -6.2280898777E+01, -6.2280897223E+01, -6.2280921079E+01, -6.2280943574E+01, -6.2280870779E+01, -6.2280639734E+01, -6.2280273968E+01, -6.2279820466E+01, -6.2279517843E+01, -6.2280253110E+01, -6.2280994828E+01, -6.2280993471E+01, -6.2280992880E+01, -6.2280993415E+01, -6.2280995010E+01, -6.2280996506E+01, -6.2280995249E+01, -6.2280989378E+01, -6.2280980059E+01, -6.2280970821E+01, -6.2280965797E+01, -6.2280966253E+01, -6.2280971286E+01, -6.2280980587E+01, -6.2280972914E+01, -6.2280878023E+01, -6.2280638988E+01, -6.2280271969E+01, -6.2279819556E+01, -6.2279517758E+01, -6.2280253159E+01, -6.2281143286E+01, -6.2281143038E+01, -6.2281143439E+01, -6.2281144880E+01, -6.2281147162E+01, -6.2281148694E+01, -6.2281144450E+01, -6.2281127739E+01, -6.2281097109E+01, -6.2281054575E+01, -6.2281005427E+01, -6.2280963321E+01, -6.2280944931E+01, -6.2280954043E+01, -6.2280956654E+01, -6.2280870431E+01, -6.2280636487E+01, -6.2280271746E+01, -6.2279819701E+01, -6.2279517795E+01, -6.2280253159E+01, -6.2281100334E+01, -6.2281099565E+01, -6.2281098921E+01, -6.2281098404E+01, -6.2281097270E+01, -6.2281093543E+01, -6.2281085281E+01, -6.2281071022E+01, -6.2281049069E+01, -6.2281018958E+01, -6.2280982464E+01, -6.2280948281E+01, -6.2280932879E+01, -6.2280944893E+01, -6.2280952601E+01, -6.2280870496E+01, -6.2280637251E+01, -6.2280271976E+01, -6.2279819710E+01, -6.2279517796E+01, -6.2280253167E+01];
    E_vs_kt = (E_vs_kt .+ 62.3) * 1e3;
    E_vs_kt = reshape(E_vs_kt, (21, 10));
end

begin
    fig = Figure(size=(450, 300), figure_padding=2)
    ax = Axis(
        fig[1,1], 
        xscale=log10,
        xticks=vcat(1:1:10, 20:10:80),
        xlabel="Smearing (mHa)", 
        ylabel="Total Energy (mHa) (62.3 mHa offset)"
    );
    xlims!(ax, nothing, 90);
    ylims!(ax, 18.8, 20.6)
    x = logrange(1, 100, 21);
    xx = [ones(21) x x.^2 x.^3 x.^4 x.^5 x.^6 x.^7];
    xs = logrange(1, 100, 101);
        
    sel = 5:12;
    cm = cgrad(:managua, length(sel), rev=true, categorical=true)
    for (i,k) in enumerate(sel)
        y = E_vs_kt[:, k-2]
        # A = xx \ y;
        # ys = map(v -> polynomial(v, A), xs);
        # lines!(ax, xs, ys, color=clr, linestyle=:dash)
        scatter!(ax, x, y, label="$k", color=cm[i], markersize=8)
    end

    axislegend(ax, "Number of grid points", position=:lt, orientation=:horizontal, nbanks=2, patchsize=(10,10))
    display(fig)
end

save("dft/fig/conv-kpt-smear.svg", fig, pt_per_unit=1)

# begin
#     ts = logrange(1e-3, 0.1, 21);
#     ks = 3:12;
#     params = [(k,t) for k ∈ ks for t ∈ ts];
#     text = join(map(enumerate(params)) do (i,p)
#         return "ngkpt$i $(p[1]) $(p[1]) $(p[1])\ntsmear$i $(p[2])"
#     end, "\n\n");
#     write("./gay.txt", text)
# end