using LsqFit
using CairoMakie

update_theme!(theme_latexfonts());
update_theme!(Theme(fontsize=11));

Ecut = 36:0.5:43.5;
Etot_vs_Ecut = [ -6.228175E+01, -6.228181E+01, -6.228187E+01, -6.228191E+01, -6.228194E+01, -6.228196E+01, -6.228198E+01, -6.228199E+01, -6.228200E+01, -6.228201E+01, -6.228201E+01, -6.228201E+01, -6.228202E+01, -6.228202E+01, -6.228202E+01, -6.228202E+01 ];

m(x,p) = p[1] .+ exp.(p[2]*x .+ p[3]);
fit = curve_fit(m, Ecut, Etot_vs_Ecut, [-62.282, -0.5, 12]);

begin
    fig = Figure(size=(300, 250), figure_padding=2)
    ax = Axis(fig[1,1], xlabel="Cutoff Energy (Ha)", ylabel="Total Energy (mHa) (62.3 Ha offset)");
    xs = LinRange(36, 43.5, 101);
    fit_curve = lines!(ax, xs, map(x -> (m(x,fit.param) + 62.3) *1e3, xs), linestyle=:dash, color=:black);
    points = scatter!(ax, Ecut, (Etot_vs_Ecut .+ 62.3) .* 1e3, markersize=10, color=:coral);
    axislegend(ax, [points, fit_curve], ["Points", "Exponential fit"], position=:rt);
    display(fig);
end

save("dft/fig/conv-Ecut.svg", fig, pt_per_unit=1)

# is 40.5Ha a good cutoff? Compute error:
exp(40.5*fit.param[2] + fit.param[3])*1e6 # -> 20uHa


# -------------------------------------------------------------------------------------------------------------------

# polynomial function used for fitting
polynomial(x, coeffs) = sum(enumerate(coeffs)) do (i, c)
    return c * x ^ (i-1);
end


begin
    E_vs_kt = [-6.2286380640E+01,-6.2286402161E+01,-6.2286429254E+01,-6.2286463363E+01,-6.2286506303E+01,-6.2286560360E+01,-6.2286628275E+01,-6.2286711291E+01,-6.2286801441E+01,-6.2286878956E+01,-6.2286934116E+01,-6.2286987755E+01,-6.2287075585E+01,-6.2287209533E+01,-6.2287333266E+01,-6.2287317014E+01,-6.2287022661E+01,-6.2286334441E+01,-6.2285146087E+01,-6.2283785221E+01,-6.2283425496E+01,-6.2277596752E+01,-6.2277607629E+01,-6.2277621223E+01,-6.2277638150E+01,-6.2277662505E+01,-6.2277700337E+01,-6.2277757758E+01,-6.2277839704E+01,-6.2277941617E+01,-6.2278047591E+01,-6.2278144733E+01,-6.2278240611E+01,-6.2278374290E+01,-6.2278556608E+01,-6.2278758234E+01,-6.2278932995E+01,-6.2279010680E+01,-6.2278947953E+01,-6.2278789297E+01,-6.2278760047E+01,-6.2279720817E+01,-6.2280516680E+01,-6.2280520895E+01,-6.2280526651E+01,-6.2280533542E+01,-6.2280537352E+01,-6.2280536449E+01,-6.2280543065E+01,-6.2280568715E+01,-6.2280616301E+01,-6.2280652970E+01,-6.2280606464E+01,-6.2280503692E+01,-6.2280462374E+01,-6.2280555542E+01,-6.2280711295E+01,-6.2280724673E+01,-6.2280510356E+01,-6.2280154418E+01,-6.2279735572E+01,-6.2279487695E+01,-6.2280264752E+01,-6.2280807203E+01,-6.2280804483E+01,-6.2280798793E+01,-6.2280787789E+01,-6.2280771532E+01,-6.2280750692E+01,-6.2280727211E+01,-6.2280707816E+01,-6.2280695620E+01,-6.2280686768E+01,-6.2280687766E+01,-6.2280724601E+01,-6.2280813002E+01,-6.2280926655E+01,-6.2281001544E+01,-6.2280954438E+01,-6.2280732198E+01,-6.2280354089E+01,-6.2279873597E+01,-6.2279539522E+01,-6.2280251957E+01,-6.2280923279E+01,-6.2280925671E+01,-6.2280929627E+01,-6.2280937044E+01,-6.2280950398E+01,-6.2280972480E+01,-6.2281005070E+01,-6.2281040889E+01,-6.2281052557E+01,-6.2281021139E+01,-6.2280975815E+01,-6.2280952873E+01,-6.2280968624E+01,-6.2281011388E+01,-6.2281029765E+01,-6.2280926805E+01,-6.2280652428E+01,-6.2280258964E+01,-6.2279800355E+01,-6.2279501892E+01,-6.2280241334E+01,-6.2280592292E+01,-6.2280593612E+01,-6.2280595252E+01,-6.2280596164E+01,-6.2280596798E+01,-6.2280600259E+01,-6.2280609884E+01,-6.2280626411E+01,-6.2280649003E+01,-6.2280677781E+01,-6.2280717519E+01,-6.2280775051E+01,-6.2280844379E+01,-6.2280904351E+01,-6.2280920603E+01,-6.2280835610E+01,-6.2280609549E+01,-6.2280254949E+01,-6.2279808726E+01,-6.2279508560E+01,-6.2280243747E+01,-6.2280905355E+01,-6.2280906524E+01,-6.2280908907E+01,-6.2280913593E+01,-6.2280920296E+01,-6.2280924996E+01,-6.2280922680E+01,-6.2280914262E+01,-6.2280906516E+01,-6.2280902975E+01,-6.2280898474E+01,-6.2280889356E+01,-6.2280887803E+01,-6.2280911659E+01,-6.2280934154E+01,-6.2280861360E+01,-6.2280630314E+01,-6.2280264543E+01,-6.2279811028E+01,-6.2279508381E+01,-6.2280243606E+01,-6.2280985358E+01,-6.2280984002E+01,-6.2280983413E+01,-6.2280983948E+01,-6.2280985544E+01,-6.2280987040E+01,-6.2280985783E+01,-6.2280979912E+01,-6.2280970592E+01,-6.2280961354E+01,-6.2280956330E+01,-6.2280956787E+01,-6.2280961821E+01,-6.2280971122E+01,-6.2280963450E+01,-6.2280868560E+01,-6.2280629525E+01,-6.2280262501E+01,-6.2279810075E+01,-6.2279508254E+01,-6.2280243613E+01,-6.2281133824E+01,-6.2281133575E+01,-6.2281133977E+01,-6.2281135418E+01,-6.2281137699E+01,-6.2281139232E+01,-6.2281134988E+01,-6.2281118277E+01,-6.2281087647E+01,-6.2281045114E+01,-6.2280995965E+01,-6.2280953859E+01,-6.2280935470E+01,-6.2280944583E+01,-6.2280947194E+01,-6.2280860973E+01,-6.2280627028E+01,-6.2280262282E+01,-6.2279810225E+01,-6.2279508295E+01,-6.2280243619E+01,-6.2281090865E+01,-6.2281090096E+01,-6.2281089451E+01,-6.2281088934E+01,-6.2281087799E+01,-6.2281084072E+01,-6.2281075810E+01,-6.2281061551E+01,-6.2281039598E+01,-6.2281009487E+01,-6.2280972993E+01,-6.2280938810E+01,-6.2280923408E+01,-6.2280935421E+01,-6.2280943130E+01,-6.2280861025E+01,-6.2280627779E+01,-6.2280262498E+01,-6.2279810219E+01,-6.2279508281E+01,-6.2280243610E+01];
    E_vs_kt = (E_vs_kt .+ 62.3) * 1e3;
    E_vs_kt = reshape(E_vs_kt, (21, 10));
end

begin
    fig = Figure(size=(450, 300), figure_padding=2)
    ax = Axis(
        fig[1,1], 
        xscale=log10,
        xticks=vcat(1:1:10, 20:10:80),
        xlabel="Smearing (mHa)", 
        ylabel="Total Energy (mHa) (62.3 mHa offset)"
    );
    xlims!(ax, nothing, 90);
    ylims!(ax, 18.8, 20.6)
    x = logrange(1, 100, 21);
    xx = [ones(21) x x.^2 x.^3 x.^4 x.^5 x.^6 x.^7];
    xs = logrange(1, 100, 101);
        
    sel = 5:12;
    cm = cgrad(:managua, length(sel), rev=true, categorical=true)
    for (i,k) in enumerate(sel)
        y = E_vs_kt[:, k-2]
        # A = xx \ y;
        # ys = map(v -> polynomial(v, A), xs);
        # lines!(ax, xs, ys, color=clr, linestyle=:dash)
        scatter!(ax, x, y, label="$k", color=cm[i], markersize=8)
    end

    axislegend(ax, "Number of grid points", position=:lt, orientation=:horizontal, nbanks=2, patchsize=(10,10))
    display(fig)
end

save("dft/fig/conv-kpt-smear.svg", fig, pt_per_unit=1)

# begin
#     ts = logrange(1e-3, 0.1, 21);
#     ks = 3:12;
#     params = [(k,t) for k ∈ ks for t ∈ ts];
#     text = join(map(enumerate(params)) do (i,p)
#         return "ngkpt$i $(p[1]) $(p[1]) $(p[1])\ntsmear$i $(p[2])"
#     end, "\n\n");
#     write("./gay.txt", text)
# end