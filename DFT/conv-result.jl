using LsqFit
using CairoMakie
using Printf

update_theme!(theme_latexfonts());
update_theme!(Theme(fontsize=11));

Ecut = 36:0.5:44;

Etot_vs_Ecut = [-6.2285790154E+01, -6.2285849502E+01, -6.2285904270E+01, -6.2285945829E+01, -6.2285976267E+01, -6.2286001080E+01, -6.2286019005E+01, -6.2286032600E+01, -6.2286042732E+01, -6.2286050036E+01, -6.2286054333E+01, -6.2286057372E+01, -6.2286059439E+01, -6.2286060592E+01, -6.2286061217E+01, -6.2286061528E+01, -6.2286061662E+01];

Etot_vs_Ecut = [-6.2286132783E+01, -6.2286199954E+01, -6.2286252637E+01, -6.2286293808E+01, -6.2286325651E+01, -6.2286349906E+01, -6.2286368205E+01, -6.2286381722E+01, -6.2286391610E+01, -6.2286398519E+01, -6.2286403260E+01, -6.2286406388E+01, -6.2286408355E+01, -6.2286409505E+01, -6.2286410131E+01, -6.2286410427E+01, -6.2286410570E+01];

m(x, p) = p[1] .+ exp.(p[2] * x .+ p[3]);
fit = curve_fit(m, Ecut, Etot_vs_Ecut, [-62.282, -0.5, 12]);

begin
    fig = Figure(size=(300, 250), figure_padding=2)
    ax = Axis(fig[1, 1], xlabel="Cutoff Energy (Ha)", ylabel="Total Energy (mHa) (62.3 Ha offset)")
    xs = LinRange(36, 43.5, 101)
    fit_curve = lines!(ax, xs, map(x -> (m(x, fit.param) + 62.3) * 1e3, xs), linestyle=:dash, color=:black)
    points = scatter!(ax, Ecut, (Etot_vs_Ecut .+ 62.3) .* 1e3, markersize=10, color=:coral)
    axislegend(ax, [points, fit_curve], ["Points", "Exponential fit"], position=:rt)
    display(fig)
end

save("dft/fig/conv-Ecut.svg", fig, pt_per_unit=1)

# is 42Ha a good cutoff? Compute error:
exp(42 * fit.param[2] + fit.param[3]) * 1e6   # -> 8.9uHa
(Etot_vs_Ecut[13] - Etot_vs_Ecut[end]) * 1e6  # -> 2.2uHa

# --------------------------------------------------------

tsmear = [5.00000000E-02, 3.97164117E-02, 3.15478672E-02, 2.50593617E-02, 1.99053585E-02, 1.58113883E-02, 1.25594322E-02, 9.97631157E-03, 7.92446596E-03, 6.29462706E-03, 5.00000000E-03, 3.97164117E-03, 3.15478672E-03, 2.50593617E-03, 1.99053585E-03, 1.58113883E-03];

Etot_vs_tsmear = [-6.2285694571E+01, -6.2286075105E+01, -6.2286310545E+01, -6.2286392917E+01, -6.2286385722E+01, -6.2286372260E+01, -6.2286382146E+01, -6.2286408666E+01, -6.2286438650E+01, -6.2286463277E+01, -6.2286479399E+01, -6.2286487941E+01, -6.2286491726E+01, -6.2286493179E+01, -6.2286493440E+01, -6.2286493145E+01];

begin
    fig = Figure(size=(400, 250), figure_padding=2)
    ax = Axis(
        fig[1, 1],
        xscale=log10,
        xticks=vcat(1:1:10, 20:10:50),
        xlabel="Smearing (mHa)",
        ylabel="Total Energy (mHa) (62.3 Ha offset)",
    )
    scatter!(ax, tsmear * 1e3, (Etot_vs_tsmear .+ 62.3) * 1e3, markersize=10, color=:aquamarine3)
    display(fig)
end

save("dft/fig/conv-smear.svg", fig, pt_per_unit=1)


# -------------------------------------------------------------------------------------------------------------------

# polynomial function used for fitting
polynomial(x, coeffs) =
    sum(enumerate(coeffs)) do (i, c)
        return c * x^(i - 1)
    end

begin
    struct AsinhTransform
        α::Float64
        AsinhTransform(σ::Number) = new(0.5 * exp10(σ))
    end
    function (f::AsinhTransform)(x)
        return asinh.(0.5 * f.α * x) / log(10)
    end
    struct AsinhInverseTransform
        d::Float64
    end
    function (f::AsinhInverseTransform)(x)
        return f.d * sinh.(x * log(10))
    end
    Makie.inverse_transform(s::AsinhTransform) = AsinhInverseTransform(2 / s.α)
    Makie.defined_interval(::AsinhTransform) = Makie.OpenInterval(-Inf, Inf)
    Makie.defaultlimits(::AsinhTransform) = (-1000.0, 1000.0)
end

begin
    cubic_root_transform(x) = cbrt.(x)
    cubic_power_transform(x) = x .^ 3
    Makie.inverse_transform(::typeof(cubic_root_transform)) = cubic_power_transform
    Makie.defaultlimits(::typeof(cubic_root_transform)) = (-1000.0, 1000.0) # Example default range
    Makie.defined_interval(::typeof(cubic_root_transform)) = Makie.OpenInterval(-Inf, Inf)
end


begin
    #E_vs_kt = [-6.2291829074E+01,-6.2291850596E+01,-6.2291877689E+01,-6.2291911798E+01,-6.2291954738E+01,-6.2292008795E+01,-6.2292076713E+01,-6.2292159775E+01,-6.2292250136E+01,-6.2292328058E+01,-6.2292383554E+01,-6.2292437131E+01,-6.2292524101E+01,-6.2292656240E+01,-6.2292778517E+01,-6.2292762576E+01,-6.2292470060E+01,-6.2291783451E+01,-6.2290594936E+01,-6.2289232654E+01,-6.2288870809E+01,-6.2283046078E+01,-6.2283056985E+01,-6.2283070518E+01,-6.2283087568E+01,-6.2283112500E+01,-6.2283151216E+01,-6.2283209610E+01,-6.2283292445E+01,-6.2283395247E+01,-6.2283502441E+01,-6.2283600796E+01,-6.2283696989E+01,-6.2283829439E+01,-6.2284009817E+01,-6.2284210203E+01,-6.2284384673E+01,-6.2284463211E+01,-6.2284401687E+01,-6.2284242726E+01,-6.2284210868E+01,-6.2285167897E+01,-6.2285970799E+01,-6.2285975123E+01,-6.2285980912E+01,-6.2285987486E+01,-6.2285991638E+01,-6.2285993014E+01,-6.2286000903E+01,-6.2286026380E+01,-6.2286072916E+01,-6.2286108016E+01,-6.2286059439E+01,-6.2285955075E+01,-6.2285912916E+01,-6.2286005297E+01,-6.2286160175E+01,-6.2286173532E+01,-6.2285960305E+01,-6.2285605574E+01,-6.2285186751E+01,-6.2284936928E+01,-6.2285710758E+01,-6.2286253238E+01,-6.2286250571E+01,-6.2286245093E+01,-6.2286234554E+01,-6.2286218764E+01,-6.2286198130E+01,-6.2286174478E+01,-6.2286155003E+01,-6.2286142969E+01,-6.2286134131E+01,-6.2286134962E+01,-6.2286171497E+01,-6.2286259339E+01,-6.2286372705E+01,-6.2286448271E+01,-6.2286402809E+01,-6.2286182547E+01,-6.2285805863E+01,-6.2285325237E+01,-6.2284989119E+01,-6.2285698345E+01,-6.2286371120E+01,-6.2286374091E+01,-6.2286378446E+01,-6.2286385923E+01,-6.2286399024E+01,-6.2286420631E+01,-6.2286452524E+01,-6.2286487264E+01,-6.2286497327E+01,-6.2286464672E+01,-6.2286419131E+01,-6.2286396483E+01,-6.2286412827E+01,-6.2286456661E+01,-6.2286476565E+01,-6.2286375409E+01,-6.2286102947E+01,-6.2285711001E+01,-6.2285252370E+01,-6.2284951836E+01,-6.2285688016E+01,-6.2286030921E+01,-6.2286033008E+01,-6.2286035219E+01,-6.2286036612E+01,-6.2286037807E+01,-6.2286041927E+01,-6.2286052261E+01,-6.2286069421E+01,-6.2286092478E+01,-6.2286121636E+01,-6.2286161826E+01,-6.2286219896E+01,-6.2286289680E+01,-6.2286350184E+01,-6.2286367556E+01,-6.2286284329E+01,-6.2286060199E+01,-6.2285707033E+01,-6.2285260736E+01,-6.2284958504E+01,-6.2285690439E+01,-6.2286345824E+01,-6.2286347725E+01,-6.2286350842E+01,-6.2286356127E+01,-6.2286363151E+01,-6.2286367892E+01,-6.2286365627E+01,-6.2286357512E+01,-6.2286350220E+01,-6.2286346959E+01,-6.2286342387E+01,-6.2286333154E+01,-6.2286331987E+01,-6.2286356905E+01,-6.2286380921E+01,-6.2286309876E+01,-6.2286080707E+01,-6.2285716412E+01,-6.2285262851E+01,-6.2284958147E+01,-6.2285690120E+01,-6.2286425790E+01,-6.2286424576E+01,-6.2286424078E+01,-6.2286424640E+01,-6.2286426189E+01,-6.2286427499E+01,-6.2286425891E+01,-6.2286419676E+01,-6.2286410300E+01,-6.2286401469E+01,-6.2286397313E+01,-6.2286398938E+01,-6.2286405265E+01,-6.2286416033E+01,-6.2286410085E+01,-6.2286317090E+01,-6.2286079977E+01,-6.2285714424E+01,-6.2285261946E+01,-6.2284958063E+01,-6.2285690169E+01,-6.2286575049E+01,-6.2286574762E+01,-6.2286575142E+01,-6.2286576560E+01,-6.2286578753E+01,-6.2286580164E+01,-6.2286575869E+01,-6.2286559242E+01,-6.2286528930E+01,-6.2286486953E+01,-6.2286438493E+01,-6.2286397154E+01,-6.2286379652E+01,-6.2286389904E+01,-6.2286393993E+01,-6.2286309531E+01,-6.2286077481E+01,-6.2285714202E+01,-6.2285262091E+01,-6.2284958099E+01,-6.2285690169E+01,-6.2286534781E+01,-6.2286533882E+01,-6.2286533131E+01,-6.2286532474E+01,-6.2286531099E+01,-6.2286527060E+01,-6.2286518534E+01,-6.2286504137E+01,-6.2286482191E+01,-6.2286452220E+01,-6.2286415981E+01,-6.2286382237E+01,-6.2286367566E+01,-6.2286380715E+01,-6.2286389931E+01,-6.2286309596E+01,-6.2286078242E+01,-6.2285714430E+01,-6.2285262100E+01,-6.2284958101E+01,-6.2285690178E+01];

    # occopt 4
    E_vs_kt = [-6.2285122973E+01, -6.2285980039E+01, -6.2286595624E+01, -6.2286947559E+01, -6.2287096327E+01, -6.2287147870E+01, -6.2287183613E+01, -6.2287231608E+01, -6.2287298326E+01, -6.2287365713E+01, -6.2287388922E+01, -6.2287365362E+01, -6.2287330315E+01, -6.2287299881E+01, -6.2287275575E+01, -6.2287256266E+01, -6.2285580566E+01, -6.2285746602E+01, -6.2285810512E+01, -6.2285814042E+01, -6.2285815197E+01, -6.2285827627E+01, -6.2285864947E+01, -6.2285935939E+01, -6.2286020064E+01, -6.2286094285E+01, -6.2286144638E+01, -6.2286165025E+01, -6.2286168290E+01, -6.2286163722E+01, -6.2286157274E+01, -6.2286151706E+01, -6.2285783736E+01, -6.2286286139E+01, -6.2286673383E+01, -6.2286870364E+01, -6.2286915182E+01, -6.2286931389E+01, -6.2286987907E+01, -6.2287079358E+01, -6.2287184801E+01, -6.2287280459E+01, -6.2287345569E+01, -6.2287377670E+01, -6.2287390528E+01, -6.2287396571E+01, -6.2287400547E+01, -6.2287403337E+01, -6.2285697034E+01, -6.2286006652E+01, -6.2286151673E+01, -6.2286115375E+01, -6.2285960537E+01, -6.2285792115E+01, -6.2285667246E+01, -6.2285595011E+01, -6.2285564722E+01, -6.2285563245E+01, -6.2285578429E+01, -6.2285598046E+01, -6.2285615191E+01, -6.2285629795E+01, -6.2285642708E+01, -6.2285653800E+01, -6.2285720397E+01, -6.2286102649E+01, -6.2286361151E+01, -6.2286477520E+01, -6.2286514661E+01, -6.2286555041E+01, -6.2286625177E+01, -6.2286708970E+01, -6.2286785856E+01, -6.2286849308E+01, -6.2286899842E+01, -6.2286935600E+01, -6.2286954075E+01, -6.2286960223E+01, -6.2286960936E+01, -6.2286960187E+01, -6.2285716157E+01, -6.2286075872E+01, -6.2286299146E+01, -6.2286374229E+01, -6.2286356394E+01, -6.2286321621E+01, -6.2286299439E+01, -6.2286293015E+01, -6.2286300448E+01, -6.2286313760E+01, -6.2286323727E+01, -6.2286327569E+01, -6.2286328098E+01, -6.2286327985E+01, -6.2286327491E+01, -6.2286326561E+01, -6.2285716574E+01, -6.2286082486E+01, -6.2286314876E+01, -6.2286393912E+01, -6.2286383151E+01, -6.2286374246E+01, -6.2286399708E+01, -6.2286447610E+01, -6.2286497537E+01, -6.2286534764E+01, -6.2286552796E+01, -6.2286554321E+01, -6.2286548121E+01, -6.2286541167E+01, -6.2286535860E+01, -6.2286532244E+01, -6.2285716634E+01, -6.2286080989E+01, -6.2286311300E+01, -6.2286395012E+01, -6.2286392704E+01, -6.2286378619E+01, -6.2286378913E+01, -6.2286392686E+01, -6.2286411911E+01, -6.2286430956E+01, -6.2286446775E+01, -6.2286457381E+01, -6.2286463948E+01, -6.2286468862E+01, -6.2286473063E+01, -6.2286476519E+01, -6.2285716602E+01, -6.2286081306E+01, -6.2286312079E+01, -6.2286391854E+01, -6.2286381045E+01, -6.2286366368E+01, -6.2286380470E+01, -6.2286414709E+01, -6.2286452208E+01, -6.2286481358E+01, -6.2286499199E+01, -6.2286507770E+01, -6.2286510381E+01, -6.2286510449E+01, -6.2286510024E+01, -6.2286509589E+01, -6.2285716597E+01, -6.2286081243E+01, -6.2286311905E+01, -6.2286393794E+01, -6.2286388139E+01, -6.2286373935E+01, -6.2286378520E+01, -6.2286399133E+01, -6.2286426886E+01, -6.2286452443E+01, -6.2286471043E+01, -6.2286483334E+01, -6.2286491672E+01, -6.2286498067E+01, -6.2286503345E+01, -6.2286507342E+01, -6.22857166151601E+01, -6.22860812567759E+01, -6.22863119502327E+01, -6.22863929165086E+01, -6.22863848667138E+01, -6.22863713853012E+01, -6.22863833435619E+01, -6.22864142098796E+01, -6.22864489531937E+01, -6.22864774070200E+01, -6.22864959514338E+01, -6.22865051075829E+01, -6.22865082590408E+01, -6.22865090147147E+01, -6.22865093926964E+01, -6.22865099798941E+01, -6.22857165953622E+01, -6.22860812572304E+01, -6.22863119410538E+01, -6.22863932598712E+01, -6.22863860948398E+01, -6.22863713876000E+01, -6.22863789341925E+01, -6.22864053831330E+01, -6.22864390401666E+01, -6.22864691565496E+01, -6.22864901461049E+01, -6.22865020522695E+01, -6.22865077375988E+01, -6.22865099711170E+01, -6.22865103632135E+01, -6.22865097407919E+01, -6.22857166113573E+01, -6.22860812598891E+01, -6.22863119466760E+01, -6.22863931431570E+01, -6.22863857401371E+01, -6.22863722605975E+01, -6.22863821455042E+01, -6.22864086658834E+01, -6.22864386503800E+01, -6.22864632773974E+01, -6.22864793990294E+01, -6.22864879409617E+01, -6.22864917259284E+01, -6.22864931792220E+01, -6.22864934403948E+01, -6.22864931451993E+01, -6.22857165905619E+01, -6.22860812518864E+01, -6.22863119383225E+01, -6.22863931741623E+01, -6.22863857949913E+01, -6.22863713794887E+01, -6.22863802462417E+01, -6.22864090929211E+01, -6.22864453572830E+01, -6.22864771875971E+01, -6.22864990906256E+01, -6.22865119083363E+01, -6.22865188414584E+01, -6.22865224532555E+01, -6.22865240634547E+01, -6.22865245525093E+01]

    # occopt 7
    # E_vs_kt = [-6.23051419087891E+01,-6.22982085946934E+01,-6.22935509838144E+01,-6.22903429018988E+01,-6.22881112417192E+01,-6.22865634617946E+01,-6.22855007082479E+01,-6.22847804143708E+01,-6.22842927734503E+01,-6.22839547421732E+01,-6.22837107146885E+01,-6.22835283067864E+01,-6.22833909143210E+01,-6.22832890412229E+01,-6.22832155126880E+01,-6.22831639427396E+01,-6.23061313003381E+01,-6.22995255497609E+01,-6.22952166208918E+01,-6.22923394152057E+01,-6.22903736353282E+01,-6.22890063834648E+01,-6.22880498969307E+01,-6.22873887604778E+01,-6.22869444428422E+01,-6.22866559449337E+01,-6.22864753257723E+01,-6.22863675663222E+01,-6.22863079042167E+01,-6.22862784464505E+01,-6.22862659674772E+01,-6.22862616206031E+01,-6.23060981373700E+01,-6.22994556911469E+01,-6.22951072677709E+01,-6.22922057028036E+01,-6.22902465128822E+01,-6.22889158639355E+01,-6.22880077004480E+01,-6.22873848627511E+01,-6.22869562380675E+01,-6.22866612533078E+01,-6.22864592041326E+01,-6.22863217815718E+01,-6.22862288007227E+01,-6.22861661541737E+01,-6.22861245071534E+01,-6.22860972852836E+01,-6.23060971060768E+01,-6.22994572281663E+01,-6.22951181857465E+01,-6.22922345806348E+01,-6.22903022475285E+01,-6.22890093567183E+01,-6.22881492735149E+01,-6.22875782032960E+01,-6.22871975690545E+01,-6.22869434751846E+01,-6.22867743620652E+01,-6.22866612913710E+01,-6.22865845420270E+01,-6.22865316614523E+01,-6.22864950214293E+01,-6.22864698972026E+01,-6.23060972942443E+01,-6.22994576846759E+01,-6.22951182446009E+01,-6.22922306221046E+01,-6.22902862807499E+01,-6.22889737113670E+01,-6.22880945874508E+01,-6.22875163036167E+01,-6.22871448711867E+01,-6.22869112709097E+01,-6.22867662882462E+01,-6.22866769339312E+01,-6.22866220492886E+01,-6.22865882352746E+01,-6.22865672052420E+01,-6.22865541171363E+01,-6.23060972686501E+01,-6.22994576041933E+01,-6.22951180500228E+01,-6.22922307699306E+01,-6.22902885250180E+01,-6.22889804655236E+01,-6.22881061565230E+01,-6.22875292319775E+01,-6.22871549151727E+01,-6.22869161831031E+01,-6.22867654465470E+01,-6.22866701794627E+01,-6.22866092110039E+01,-6.22865694146137E+01,-6.22865432049989E+01,-6.22865262093260E+01,-6.23060972851024E+01,-6.22994576146999E+01,-6.22951180869428E+01,-6.22922308968566E+01,-6.22902884804823E+01,-6.22889791001065E+01,-6.22881025570390E+01,-6.22875245278845E+01,-6.22871516964940E+01,-6.22869168311673E+01,-6.22867714054331E+01,-6.22866821694857E+01,-6.22866277767050E+01,-6.22865948995238E+01,-6.22865750757431E+01,-6.22865629178677E+01,-6.23060972841319E+01,-6.22994576146603E+01,-6.22951180856863E+01,-6.22922308679236E+01,-6.22902883992413E+01,-6.22889793074760E+01,-6.22881038394306E+01,-6.22875266171878E+01,-6.22871521840905E+01,-6.22869124300837E+01,-6.22867598547057E+01,-6.22866629079570E+01,-6.22866013393001E+01,-6.22865621642422E+01,-6.22865369690550E+01,-6.22865203480120E+01,-6.23060972650423E+01,-6.22994576091916E+01,-6.22951180799334E+01,-6.22922308655088E+01,-6.22902884223749E+01,-6.22889793137829E+01,-6.22881035211331E+01,-6.22875257594029E+01,-6.22871513867445E+01,-6.22869129483126E+01,-6.22867626642073E+01,-6.22866681554499E+01,-6.22866086248934E+01,-6.22865710508292E+01,-6.22865472898362E+01,-6.22865322479125E+01,-6.23060972705265E+01,-6.22994576088757E+01,-6.22951180795447E+01,-6.22922308650221E+01,-6.22902884151681E+01,-6.22889792768858E+01,-6.22881035184695E+01,-6.22875259704661E+01,-6.22871517191811E+01,-6.22869130387033E+01,-6.22867624763248E+01,-6.22866680788763E+01,-6.22866090225752E+01,-6.22865720567042E+01,-6.22865489252374E+01,-6.22865344955011E+01,-6.23060972699516E+01,-6.22994576090827E+01,-6.22951180797291E+01,-6.22922308653116E+01,-6.22902884162802E+01,-6.22889792917453E+01,-6.22881035498944E+01,-6.22875258923405E+01,-6.22871513979875E+01,-6.22869126299217E+01,-6.22867623571188E+01,-6.22866686135003E+01,-6.22866104550020E+01,-6.22865744226469E+01,-6.22865519708935E+01,-6.22865377962917E+01];

    Nkpt = length(E_vs_kt) ÷ 16
    offset = E_vs_kt[end-32]
    # @views offset = sum(E_vs_kt[16:16:end]) / length(E_vs_kt[16:16:end]);

    E_vs_kt = (E_vs_kt .- offset) * 1e6
    E_vs_kt = reshape(E_vs_kt, (16, Nkpt))
end

begin
    fig = Figure(figure_padding=3, fontsize=22)
    hgt = 350

    ax = Axis(
        fig[1, 2],
        width=hgt, height=hgt,
        tellheight=true,
        xscale=log10,
        xticks=[2, 3, 4, 5, 6, 7, 8, 10, 20, 30, 40],
        xminorticks=[9, 50],
        xminorticksvisible=true,
        xminorgridvisible=true,
        xminorgridstyle=:solid,
        xminorgridcolor=RGBAf(0, 0, 0, 0.12),
        xlabel="Smearing (mHa)",
        yaxisposition=:left,
        ylabel=L"E_{tot} - E_\mathrm{offset}\quad\mathrm{(μHa)}",
        yticks=(
            [-10, -1, -0.1, -0.01, 0.01, 0.1, 1] * 1e3,
            [L"-10^4", L"-10^3", L"-10^{2}", L"-10^{1}", L"10^{1}", L"10^{2}", L"10^{3}"]
        ),
        # occopt 4
        yscale=AsinhTransform(-0.3),
        # yscale=identity
        # occopt 7
        # yscale=AsinhTransform(-0.7),
    )
    # xlims!(ax, 1.32, 60)
    # hlines!(ax, [-20, +20], color=:gray80, linestyle=:dot)
    ksel = 2:Nkpt
    tsel = 1:16
    x = tsmear[tsel] * 1e3

    @views av = sum(E_vs_kt[:, end-3:end], dims=2) .* 0.25
    @views y = av[tsel]
    lines!(ax, x, y, color=:gray70, linestyle=:dot)
    scatter!(ax, x, y, color=:gray70, markersize=10, marker=:star5)

    cm = cgrad(:linear_gow_60_85_c27_n256, length(ksel), rev=true, categorical=true)
    for (i, c) in enumerate(ksel)
        y = E_vs_kt[tsel, c]
        lines!(ax, x, y, linestyle=:dash, color=cm[i])
        scatter!(ax, x, y, label="$(2c+2)", color=cm[i], markersize=8)
    end

    Legend(fig[1, 1], ax,
        orientation=:vertical,
        tellwidth=true,
        tellheight=false,
        patchsize=(10, 10),
        padding=(42, 8, 12, 12),
        backgroundcolor=:transparent
    )

    Label(fig[1, 1], "Number of grid points",
        rotation=π / 2, font=:bold,
        halign=:left, valign=:center,
        alignmode=Outside(3, 0, 0, 0),
    )


    ksel = 5:Nkpt
    tsel = 6:15
    x = ksel * 2 .+ 2
    cm = cgrad(:managua, length(tsel), rev=false, categorical=true)
    ax = Axis(
        fig[1, 3], width=180, height=hgt,
        xticks=x,
        xticklabelrotation=0.5π,
        xlabel="Number of\ngrid points",
        ylabel=L"\left|E_{tot} - E_\mathrm{mean}\right|\quad\mathrm{(μHa)}",
        yaxisposition=:right, tellheight=true,
        # occopt 4
        yscale=AsinhTransform(0.1),
        yticks=[0, 2, 5, 10, 20, 50, 100, 200, 500],
        # occopt 7
        # yscale=AsinhTransform(-0.1),
        # yticks=[0, 2, 5, 10, 20],
    )

    for (i, t) ∈ enumerate(tsel)
        y = abs.(E_vs_kt[t, ksel] .- av[t])
        label = @sprintf("%.1f", tsmear[t] * 1e3)
        lines!(ax, x, y, color=cm[i], linestyle=:dot)
        scatter!(ax, x, y, color=cm[i], markersize=9, marker=:utriangle, label=label)
    end

    Legend(fig[1, 4], ax,
        backgroundcolor=:transparent,
        tellwidth=true,
        tellheight=false,
        padding=(8, 40, 8, 8),
        patchsize=(10, 10)
    )
    Label(fig[1, 4], "Smearing (mHa)",
        rotation=π / 2, font=:bold,
        halign=:right, valign=:center,
        alignmode=Outside(0, 4, 0, 0),
    )

    resize_to_layout!(fig)
    display(fig)
end

# occopt 4
save("dft/fig/conv-kpt-smear-marzari.svg", fig, pt_per_unit=2)
# occopt 7
save("dft/fig/conv-kpt-smear-gauss.svg", fig, pt_per_unit=2)
